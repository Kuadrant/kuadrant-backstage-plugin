# CI and Release Pipelines

## Workflows

Three GitHub Actions workflows in `.github/workflows/`:

| Workflow | Trigger | Purpose |
|-|-|
| `ci.yml` | PRs, pushes to main | Build, lint, type-check, unit tests, e2e tests |
| `release.yml` | Manual (`workflow_dispatch`) | Create GitHub Release with tag and tarballs |
| `publish.yml` | GitHub Release published, or manual | Publish packages to npm |

## Release Flow

```
workflow_dispatch on release.yml
  -> reads version from plugins/kuadrant/package.json
  -> creates git tag (v0.1.0 etc)
  -> builds + exports dynamic plugins
  -> creates GitHub Release with .tgz artifacts
     -> triggers publish.yml (release: published event)
        -> publishes 3 packages to npm
```

Manual `workflow_dispatch` on `publish.yml` publishes with a `dev` dist-tag using `{version}-{git-sha}` as the version.

## Published Packages

| Package | Source | Purpose |
|-|-|-|
| [`@kuadrant/kuadrant-backstage-plugin-frontend`](https://www.npmjs.com/package/@kuadrant/kuadrant-backstage-plugin-frontend) | `plugins/kuadrant` | Frontend plugin (works for both static Backstage and RHDH) |
| [`@kuadrant/kuadrant-backstage-plugin-backend`](https://www.npmjs.com/package/@kuadrant/kuadrant-backstage-plugin-backend) | `plugins/kuadrant-backend` | Backend plugin (static install) |
| [`@kuadrant/kuadrant-backstage-plugin-backend-dynamic`](https://www.npmjs.com/package/@kuadrant/kuadrant-backstage-plugin-backend-dynamic) | `plugins/kuadrant-backend/dist-dynamic` | Backend plugin (dynamic, for RHDH) |

## Static vs Dynamic Plugins

Standard Backstage plugins are **static**: they're installed as npm dependencies and linked at build time. This is how most Backstage deployments work.

**Red Hat Developer Hub (RHDH)** supports **dynamic plugins** loaded at runtime, without rebuilding the app. Dynamic plugins use [Scalprum](https://github.com/scalprum/scaffolding) for frontend and a separate packaging format for backend.

### Frontend: One Package, Both Modes

The frontend plugin (`@kuadrant/kuadrant-backstage-plugin-frontend`) works in both contexts:

- **Static Backstage**: Consumers install it as a normal dependency. Uses `dist/index.esm.js`.
- **RHDH dynamic loading**: Uses `dist-scalprum/` directory generated by `janus-cli package export-dynamic-plugin --in-place`. The `scalprum` config in `package.json` defines the exposed modules.

Key config in `plugins/kuadrant/package.json`:
```json
"scalprum": {
  "name": "internal.plugin-kuadrant",
  "exposedModules": {
    "PluginRoot": "./src/plugin.ts",
    ...
  }
}
```

The `files` array includes `dist-scalprum` so it ships with the npm package.

### Backend: Two Separate Packages

Unlike the frontend, the backend has two distinct packages:

- **Static** (`@kuadrant/kuadrant-backstage-plugin-backend`): Standard backend plugin. `npm pack` from `plugins/kuadrant-backend/`.
- **Dynamic** (`@kuadrant/kuadrant-backstage-plugin-backend-dynamic`): Generated by `janus-cli package export-dynamic-plugin --in-place` into `plugins/kuadrant-backend/dist-dynamic/`. This is a separate directory with its own `package.json`, published as a distinct npm package.

## The `export-dynamic` Step

Both plugins have an `export-dynamic` script that runs `janus-cli package export-dynamic-plugin --in-place`:

- **Frontend**: Generates `dist-scalprum/` inside `plugins/kuadrant/`. This directory is included in the frontend npm package's `files` array, so it ships alongside the static build.
- **Backend**: Generates `dist-dynamic/` inside `plugins/kuadrant-backend/`. This directory is treated as a standalone package and published separately.

Both workflows (`release.yml` and `publish.yml`) run `export-dynamic` on both plugins. Without it, the frontend would be missing `dist-scalprum` (breaking RHDH) and the backend dynamic package wouldn't exist.

## CI Pipeline

`ci.yml` runs three parallel jobs:

- **build-validate**: Lint, prettier, type-check, build, verify output bundles exist
- **unittests**: Backend and frontend unit tests
- **e2e-tests**: Spins up a kind cluster with Kuadrant, starts Backstage, runs Playwright tests

E2e test artifacts (Playwright report, videos on failure) are uploaded and retained for 7 days.

## npm Trusted Publishing

`publish.yml` uses npm's trusted publishing (`--provenance` flag) with GitHub's OIDC tokens (`id-token: write` permission). No npm tokens are stored as secrets.
