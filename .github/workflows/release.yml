name: Release

on:
  workflow_dispatch:

jobs:
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'yarn'

      - name: Enable Corepack
        run: corepack enable

      - name: Determine version
        id: version
        run: |
          VERSION=$(node -p "require('./plugins/kuadrant/package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "ERROR: Tag v$VERSION already exists"
            echo "Update version in package.json or delete the existing tag"
            exit 1
          fi

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build packages
        run: yarn build

      - name: Export dynamic plugins
        run: |
          cd plugins/kuadrant
          yarn export-dynamic

          cd ../kuadrant-backend
          yarn export-dynamic

      - name: Create plugin artifacts
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          cd plugins/kuadrant
          npm pack
          mv kuadrant-kuadrant-backstage-plugin-frontend-*.tgz ../../kuadrant-backstage-plugin-frontend-${VERSION}.tgz
          cd ../..

          cd plugins/kuadrant-backend
          npm pack
          mv kuadrant-kuadrant-backstage-plugin-backend-*.tgz ../../kuadrant-backstage-plugin-backend-${VERSION}.tgz
          cd ../..

          cd plugins/kuadrant-backend/dist-dynamic
          npm pack
          mv kuadrant-kuadrant-backstage-plugin-backend-dynamic-*.tgz ../../../kuadrant-backstage-plugin-backend-dynamic-${VERSION}.tgz
          cd ../../..

          echo "Created artifacts:"
          ls -lh *.tgz

      - name: Generate changelog
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            echo "First release - showing all commits"
            COMMITS=$(git log --pretty=format:"- %s (%h)")
          else
            echo "Changes since $PREV_TAG"
            COMMITS=$(git log --pretty=format:"- %s (%h)" $PREV_TAG..HEAD)
          fi

          cat > CHANGELOG.md << EOF
          ## What's Changed

          $COMMITS

          ## Installation

          ### Using npm/yarn

          \`\`\`bash
          # Frontend plugin
          yarn add @kuadrant/kuadrant-backstage-plugin-frontend@${VERSION}

          # Backend plugin (static)
          yarn add @kuadrant/kuadrant-backstage-plugin-backend@${VERSION}

          # Backend plugin (dynamic, for RHDH)
          # Use the tarball artifact or npm package:
          yarn add @kuadrant/kuadrant-backstage-plugin-backend-dynamic@${VERSION}
          \`\`\`

          ## Links

          - [Frontend plugin on npm](https://www.npmjs.com/package/@kuadrant/kuadrant-backstage-plugin-frontend/v/${VERSION})
          - [Backend plugin on npm](https://www.npmjs.com/package/@kuadrant/kuadrant-backstage-plugin-backend/v/${VERSION})
          - [Backend dynamic plugin on npm](https://www.npmjs.com/package/@kuadrant/kuadrant-backstage-plugin-backend-dynamic/v/${VERSION})
          - [Documentation](https://github.com/Kuadrant/kuadrant-backstage-plugin/blob/main/README.md)
          EOF

          cat CHANGELOG.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.tag }}
          body_path: CHANGELOG.md
          draft: false
          make_latest: true
          files: |
            *.tgz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ steps.version.outputs.tag }}"

          echo "## GitHub Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** $TAG" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Artifacts:**" >> $GITHUB_STEP_SUMMARY
          echo "- kuadrant-backstage-plugin-frontend-${VERSION}.tgz" >> $GITHUB_STEP_SUMMARY
          echo "- kuadrant-backstage-plugin-backend-${VERSION}.tgz" >> $GITHUB_STEP_SUMMARY
          echo "- kuadrant-backstage-plugin-backend-dynamic-${VERSION}.tgz" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**NPM Packages:**" >> $GITHUB_STEP_SUMMARY
          echo "- [@kuadrant/kuadrant-backstage-plugin-frontend@${VERSION}](https://www.npmjs.com/package/@kuadrant/kuadrant-backstage-plugin-frontend/v/${VERSION})" >> $GITHUB_STEP_SUMMARY
          echo "- [@kuadrant/kuadrant-backstage-plugin-backend@${VERSION}](https://www.npmjs.com/package/@kuadrant/kuadrant-backstage-plugin-backend/v/${VERSION})" >> $GITHUB_STEP_SUMMARY
          echo "- [@kuadrant/kuadrant-backstage-plugin-backend-dynamic@${VERSION}](https://www.npmjs.com/package/@kuadrant/kuadrant-backstage-plugin-backend-dynamic/v/${VERSION})" >> $GITHUB_STEP_SUMMARY
